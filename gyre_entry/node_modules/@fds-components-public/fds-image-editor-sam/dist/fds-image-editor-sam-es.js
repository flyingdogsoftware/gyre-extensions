function t(){}function e(t){return t()}function o(){return Object.create(null)}function n(t){t.forEach(e)}function i(t){return"function"==typeof t}function r(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}let l,a;function s(t,e){return l||(l=document.createElement("a")),l.href=e,t===l.href}function c(t,e){t.appendChild(e)}function u(t,e,o){t.insertBefore(e,o||null)}function d(t){t.parentNode&&t.parentNode.removeChild(t)}function p(t){return document.createElement(t)}function g(t){return document.createTextNode(t)}function h(){return g(" ")}function f(){return g("")}function m(t,e,o,n){return t.addEventListener(e,o,n),()=>t.removeEventListener(e,o,n)}function b(t,e,o){null==o?t.removeAttribute(e):t.getAttribute(e)!==o&&t.setAttribute(e,o)}function y(t,e,o){e in t?t[e]="boolean"==typeof t[e]&&""===o||o:b(t,e,o)}function x(t,e,o,n){null==o?t.style.removeProperty(e):t.style.setProperty(e,o,n?"important":"")}function A(t,e,o){t.classList[o?"add":"remove"](e)}function $(t){const e={};for(const o of t)e[o.name]=o.value;return e}function _(t){a=t}function w(t){(function(){if(!a)throw new Error("Function called outside component initialization");return a})().$$.on_mount.push(t)}const k=[],v=[];let T=[];const B=[],P=Promise.resolve();let C=!1;function E(){C||(C=!0,P.then(S))}function M(t){T.push(t)}const R=new Set;let I=0;function S(){if(0!==I)return;const t=a;do{try{for(;I<k.length;){const t=k[I];I++,_(t),N(t.$$)}}catch(t){throw k.length=0,I=0,t}for(_(null),k.length=0,I=0;v.length;)v.pop()();for(let t=0;t<T.length;t+=1){const e=T[t];R.has(e)||(R.add(e),e())}T.length=0}while(k.length);for(;B.length;)B.pop()();C=!1,R.clear(),_(t)}function N(t){if(null!==t.fragment){t.update(),n(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(M)}}const U=new Set;function D(t,e){const o=t.$$;null!==o.fragment&&(!function(t){const e=[],o=[];T.forEach((n=>-1===t.indexOf(n)?e.push(n):o.push(n))),o.forEach((t=>t())),T=e}(o.after_update),n(o.on_destroy),o.fragment&&o.fragment.d(e),o.on_destroy=o.fragment=null,o.ctx=[])}function L(r,l,s,c,u,p,g,h=[-1]){const f=a;_(r);const m=r.$$={fragment:null,ctx:[],props:p,update:t,not_equal:u,bound:o(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(l.context||(f?f.$$.context:[])),callbacks:o(),dirty:h,skip_bound:!1,root:l.target||f.$$.root};g&&g(m.root);let b=!1;if(m.ctx=s?s(r,l.props||{},((t,e,...o)=>{const n=o.length?o[0]:e;return m.ctx&&u(m.ctx[t],m.ctx[t]=n)&&(!m.skip_bound&&m.bound[t]&&m.bound[t](n),b&&function(t,e){-1===t.$$.dirty[0]&&(k.push(t),E(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}(r,t)),e})):[],m.update(),b=!0,n(m.before_update),m.fragment=!!c&&c(m.ctx),l.target){if(l.hydrate){const t=function(t){return Array.from(t.childNodes)}(l.target);m.fragment&&m.fragment.l(t),t.forEach(d)}else m.fragment&&m.fragment.c();l.intro&&((y=r.$$.fragment)&&y.i&&(U.delete(y),y.i(x))),function(t,o,r,l){const{fragment:a,after_update:s}=t.$$;a&&a.m(o,r),l||M((()=>{const o=t.$$.on_mount.map(e).filter(i);t.$$.on_destroy?t.$$.on_destroy.push(...o):n(o),t.$$.on_mount=[]})),s.forEach(M)}(r,l.target,l.anchor,l.customElement),S()}var y,x;_(f)}let q;function O(t){let e,o,i,r,l,a,s,g,f,A,$,_,w,k="points"===t[0].subTool&&z(t),v=t[1]&&F(t);return{c(){e=p("div"),k&&k.c(),o=h(),i=p("fds-image-editor-button"),i.textContent="Auto Matte",r=h(),l=p("fds-image-editor-button"),s=h(),v&&v.c(),g=h(),f=p("fds-image-editor-button"),f.textContent="Clear",A=h(),$=p("fds-image-editor-button"),x(i,"margin-left","10px"),y(i,"type","button"),y(l,"icon","fds-image-editor-sam-eye"),y(l,"title","Select by Points"),y(l,"class","iconDark"),x(l,"vertical-align","-10px"),x(l,"display","inline-block"),x(l,"height","40px"),y(l,"state",a=t[0].previewResult?"active":""),x(f,"margin-left","10px"),y(f,"type","button"),y($,"icon","moreSettings"),y($,"title","Settings"),y($,"class","iconDark"),x($,"vertical-align","-10px"),x($,"display","inline-block"),x($,"height","40px"),b(e,"class","aiSelection")},m(n,a){u(n,e,a),k&&k.m(e,null),c(e,o),c(e,i),c(e,r),c(e,l),c(e,s),v&&v.m(e,null),c(e,g),c(e,f),c(e,A),c(e,$),_||(w=[m(i,"click",t[7]),m(l,"click",t[8]),m(f,"click",t[11]),m($,"click",t[12])],_=!0)},p(t,n){"points"===t[0].subTool?k?k.p(t,n):(k=z(t),k.c(),k.m(e,o)):k&&(k.d(1),k=null),1&n&&a!==(a=t[0].previewResult?"active":"")&&y(l,"state",a),t[1]?v?v.p(t,n):(v=F(t),v.c(),v.m(e,g)):v&&(v.d(1),v=null)},d(t){t&&d(e),k&&k.d(),v&&v.d(),_=!1,n(w)}}}function V(t){let e,o,n,i,r,l,a="points"===t[0].subTool&&j(t);return{c(){e=p("div"),o=p("div"),a&&a.c(),n=h(),i=p("fds-image-editor-button"),y(i,"icon","AutoMask"),y(i,"title","Generate Matte automatically"),y(i,"class","iconDark"),x(i,"margin-top","10px"),b(o,"class","iPadToolPallete"),b(e,"class","iPadTool")},m(s,d){u(s,e,d),c(e,o),a&&a.m(o,null),c(o,n),c(o,i),r||(l=m(i,"click",t[5]),r=!0)},p(t,e){"points"===t[0].subTool?a?a.p(t,e):(a=j(t),a.c(),a.m(o,n)):a&&(a.d(1),a=null)},d(t){t&&d(e),a&&a.d(),r=!1,l()}}}function z(t){let e,o,n,i,r,l,a;return{c(){e=p("fds-image-editor-toggle"),n=h(),i=p("label"),i.textContent="Background",r=g("\n        |"),y(e,"value",o=t[0].pointMode),y(e,"name","bg"),y(e,"class","toggle"),b(i,"for","bg")},m(o,s){u(o,e,s),u(o,n,s),u(o,i,s),u(o,r,s),l||(a=m(e,"change",t[6]),l=!0)},p(t,n){1&n&&o!==(o=t[0].pointMode)&&y(e,"value",o)},d(t){t&&d(e),t&&d(n),t&&d(i),t&&d(r),l=!1,a()}}}function F(e){let o,i,r,l,a;return{c(){o=p("fds-image-editor-button"),o.textContent="New Layer",i=h(),r=p("fds-image-editor-button"),r.textContent="Set Mask",x(o,"margin-left","10px"),y(o,"type","button"),x(r,"margin-left","10px"),y(r,"type","button")},m(t,n){u(t,o,n),u(t,i,n),u(t,r,n),l||(a=[m(o,"click",e[9]),m(r,"click",e[10])],l=!0)},p:t,d(t){t&&d(o),t&&d(i),t&&d(r),l=!1,n(a)}}}function j(t){let e;function o(t,e){return 0===t[0].pointMode?Q:J}let n=o(t),i=n(t);return{c(){i.c(),e=f()},m(t,o){i.m(t,o),u(t,e,o)},p(t,r){n===(n=o(t))&&i?i.p(t,r):(i.d(1),i=n(t),i&&(i.c(),i.m(e.parentNode,e)))},d(t){i.d(t),t&&d(e)}}}function J(e){let o,n,i;return{c(){o=p("fds-image-editor-button"),y(o,"icon","foreground"),y(o,"title","Define Foreground"),y(o,"class","iconDark"),x(o,"margin-bottom","10px")},m(t,r){u(t,o,r),n||(i=m(o,"click",e[4]),n=!0)},p:t,d(t){t&&d(o),n=!1,i()}}}function Q(e){let o,n,i;return{c(){o=p("fds-image-editor-button"),y(o,"icon","background"),y(o,"title","Define Background"),y(o,"class","iconDark"),x(o,"margin-bottom","10px")},m(t,r){u(t,o,r),n||(i=m(o,"click",e[3]),n=!0)},p:t,d(t){t&&d(o),n=!1,i()}}}function G(e){let o;function n(t,e){return globalThis.gyre.iPad&&t[0]?V:t[0]?O:void 0}let i=n(e),r=i&&i(e);return{c(){r&&r.c(),o=f(),this.c=t},m(t,e){r&&r.m(t,e),u(t,o,e)},p(t,[e]){i===(i=n(t))&&r?r.p(t,e):(r&&r.d(1),r=i&&i(t),r&&(r.c(),r.m(o.parentNode,o)))},i:t,o:t,d(t){r&&r.d(t),t&&d(o)}}}function K(t,e,o){let{tool_layer:n}=e,{showImageButtons:i=!1}=e;return t.$$set=t=>{"tool_layer"in t&&o(0,n=t.tool_layer),"showImageButtons"in t&&o(1,i=t.showImageButtons)},[n,i,function(){o(0,n)},()=>{o(0,n.pointMode=!0,n),n.component.refresh()},()=>{o(0,n.pointMode=!1,n),n.component.refresh()},()=>{n.component.action("autoMatte")},t=>{o(0,n.pointMode=t.detail,n),n.component.refresh()},()=>{n.component.action("autoMatte")},()=>{o(0,n.previewResult=!n.previewResult,n),n.component.refresh()},()=>{n.component.action("loadImage")},()=>{n.component.action("setMask")},()=>{n.component.action("clear")},()=>{n.component.action("settings")}]}"function"==typeof HTMLElement&&(q=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:t}=this.$$;this.$$.on_disconnect=t.map(e).filter(i);for(const t in this.$$.slotted)this.appendChild(this.$$.slotted[t])}attributeChangedCallback(t,e,o){this[t]=o}disconnectedCallback(){n(this.$$.on_disconnect)}$destroy(){D(this,1),this.$destroy=t}$on(e,o){if(!i(o))return t;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(o),()=>{const t=n.indexOf(o);-1!==t&&n.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}});function Y(t,e,o){const n=t.slice();return n[14]=e[o],n[16]=o,n}function H(t){let e,o,n,i,r,l,a=t[5]&&W(),s=t[3]&&!t[0].previewResult&&Z(t),g=t[4]&&t[0].previewResult&&X(t);function f(t,e){return"points"!==t[0].subTool?et:tt}let y=f(t),$=y(t);return{c(){e=p("div"),a&&a.c(),o=h(),s&&s.c(),n=h(),g&&g.c(),i=h(),$.c(),b(e,"class","loiPointsBack"),x(e,"width",t[1]+"px"),x(e,"height",t[2]+"px"),x(e,"touch-action","pan-x pan-y"),A(e,"checkerBoard",t[0].previewResult)},m(d,p){u(d,e,p),a&&a.m(e,null),c(e,o),s&&s.m(e,null),c(e,n),g&&g.m(e,null),c(e,i),$.m(e,null),r||(l=m(e,"click",t[6]),r=!0)},p(t,r){t[5]?a||(a=W(),a.c(),a.m(e,o)):a&&(a.d(1),a=null),t[3]&&!t[0].previewResult?s?s.p(t,r):(s=Z(t),s.c(),s.m(e,n)):s&&(s.d(1),s=null),t[4]&&t[0].previewResult?g?g.p(t,r):(g=X(t),g.c(),g.m(e,i)):g&&(g.d(1),g=null),y===(y=f(t))&&$?$.p(t,r):($.d(1),$=y(t),$&&($.c(),$.m(e,null))),2&r&&x(e,"width",t[1]+"px"),4&r&&x(e,"height",t[2]+"px"),1&r&&A(e,"checkerBoard",t[0].previewResult)},d(t){t&&d(e),a&&a.d(),s&&s.d(),g&&g.d(),$.d(),r=!1,l()}}}function W(t){let e;return{c(){e=p("fds-image-editor-progress-bar")},m(t,o){u(t,e,o)},d(t){t&&d(e)}}}function Z(t){let e,o;return{c(){e=p("img"),s(e.src,o=t[3])||b(e,"src",o),x(e,"width",t[1]+"px"),x(e,"height",t[2]+"px"),b(e,"class","mask"),b(e,"draggable","false")},m(t,o){u(t,e,o)},p(t,n){8&n&&!s(e.src,o=t[3])&&b(e,"src",o),2&n&&x(e,"width",t[1]+"px"),4&n&&x(e,"height",t[2]+"px")},d(t){t&&d(e)}}}function X(t){let e,o;return{c(){e=p("img"),s(e.src,o=t[4])||b(e,"src",o),x(e,"width",t[1]+"px"),x(e,"height",t[2]+"px"),b(e,"draggable","false")},m(t,o){u(t,e,o)},p(t,n){16&n&&!s(e.src,o=t[4])&&b(e,"src",o),2&n&&x(e,"width",t[1]+"px"),4&n&&x(e,"height",t[2]+"px")},d(t){t&&d(e)}}}function tt(t){let e,o=t[0].points,n=[];for(let e=0;e<o.length;e+=1)n[e]=ot(Y(t,o,e));return{c(){for(let t=0;t<n.length;t+=1)n[t].c();e=f()},m(t,o){for(let e=0;e<n.length;e+=1)n[e]&&n[e].m(t,o);u(t,e,o)},p(t,i){if(129&i){let r;for(o=t[0].points,r=0;r<o.length;r+=1){const l=Y(t,o,r);n[r]?n[r].p(l,i):(n[r]=ot(l),n[r].c(),n[r].m(e.parentNode,e))}for(;r<n.length;r+=1)n[r].d(1);n.length=o.length}},d(t){!function(t,e){for(let o=0;o<t.length;o+=1)t[o]&&t[o].d(e)}(n,t),t&&d(e)}}}function et(t){let e,o;return{c(){e=p("div"),o=p("div"),b(o,"class","selectionInner selectionRect"),b(e,"class","selectionOuter"),x(e,"left",t[0]._x+"px"),x(e,"top",t[0]._y+"px"),x(e,"width",t[0]._width+"px"),x(e,"height",t[0]._height+"px"),x(e,"z-index",200)},m(n,i){u(n,e,i),c(e,o),t[10](e)},p(t,o){1&o&&x(e,"left",t[0]._x+"px"),1&o&&x(e,"top",t[0]._y+"px"),1&o&&x(e,"width",t[0]._width+"px"),1&o&&x(e,"height",t[0]._height+"px")},d(o){o&&d(e),t[10](null)}}}function ot(t){let e,o,n;function i(...e){return t[11](t[16],...e)}return{c(){e=p("div"),b(e,"class","loiPoint"),x(e,"left",t[14]._x+"px"),x(e,"top",t[14]._y+"px"),x(e,"z-index","200"),A(e,"loiPointBackground",0===t[14].label)},m(t,r){u(t,e,r),o||(n=m(e,"click",i),o=!0)},p(o,n){t=o,1&n&&x(e,"left",t[14]._x+"px"),1&n&&x(e,"top",t[14]._y+"px"),1&n&&A(e,"loiPointBackground",0===t[14].label)},d(t){t&&d(e),o=!1,n()}}}function nt(e){let o,n=e[1]&&H(e);return{c(){n&&n.c(),o=f(),this.c=t},m(t,e){n&&n.m(t,e),u(t,o,e)},p(t,[e]){t[1]?n?n.p(t,e):(n=H(t),n.c(),n.m(o.parentNode,o)):n&&(n.d(1),n=null)},i:t,o:t,d(t){n&&n.d(t),t&&d(o)}}}function it(t,e,o){let n,i,r,l,a,s,{tool_layer:c}=e;function u(){if(!globalThis.gyre||!globalThis.gyre.canvas)return;n=globalThis.gyre.canvas;let t=globalThis.gyre.dragDrop;if(o(1,i=n.calcPosition(n.width)),o(2,r=n.calcPosition(n.height)),c.points)for(let t of c.points)t._x=n.calcPosition(t.x),t._y=n.calcPosition(t.y);let e=c;e._x=n.calcPosition(e.x),e._y=n.calcPosition(e.y),e._width=n.calcPosition(e.width),e._height=n.calcPosition(e.height),e.element&&(t.remove(e),t.makeDraggable(e),t.makeResizeAble(e)),o(0,c.subTool=globalThis.gyre.selectedTool.subTool,c),o(0,c)}w((()=>{c.points||o(0,c.points=[],c),c.width||(o(0,c.width=200,c),o(0,c.height=200,c),o(0,c.x=20,c),o(0,c.y=20,c),o(0,c.dragRestriction=!0,c),o(0,c.resizeRestriction=!0,c),o(0,c.pointMode=!1,c)),u()}));let d={};function p(t,e){c.points.splice(e,1),o(0,c),t.preventDefault(!0),t.stopPropagation(!0),u()}return t.$$set=t=>{"tool_layer"in t&&o(0,c=t.tool_layer)},[c,i,r,l,a,s,function(t){if("points"!==globalThis.gyre.selectedTool.subTool)return u(),!1;let e=n.mouseCoords(t),o=0;c.pointMode||(o=1),c.points.push({x:parseInt(e.x),y:parseInt(e.y),label:o}),u()},p,u,async function(t){if(!globalThis.gyre||!globalThis.gyre.canvas)return;let e=globalThis.gyre;if(e.paletteValues.selectedLayer.url){if("clear"===t)return o(0,c.componentToolbar.showImageButtons=!1,c),c.componentToolbar.refresh(),o(0,c.points=[],c),o(3,l=null),void u();if("settings"===t){if(!e.openDialog)return;e.openDialog("fds-image-editor-sam box",d,"Settings")}if("setMask"===t&&l&&e.maskManager.loadMask(l),"loadImage"===t&&a){let t={type:"image",name:"AutoMatte",x:0,y:0,width:e.canvas.width,height:e.canvas.height,url:a};e.layerManager?(e.layerManager.addLayer(t),e.refresh()):alert("Only avalaible in main app")}if("autoMatte"===t){o(5,s=!0),await(E(),P);let t,n=async(t,o,n,i,r)=>{if("getLayerImage"===t&&"currentLayer"===o)return await e.imageAPI.urlToBase64(e.paletteValues.selectedLayer.url);if("getFile"===t&&"json_file"===o){let t;return t="points"!==globalThis.gyre.selectedTool.subTool?{boxes:[{x:c.x,y:c.y,w:c.width,h:c.height}]}:{points:c.points},JSON.stringify(t)}},i=async t=>{};t="points"!==globalThis.gyre.selectedTool.subTool?"fds-image-editor-sam box":"fds-image-editor-sam points";let r=JSON.parse(JSON.stringify(d));r.currentLayer="empty",r.json_file="empty",r.erode_kernel_size||(r.erode_kernel_size=3),r.dilate_kernel_size||(r.dilate_kernel_size=3);let u=async t=>{o(5,s=!1);let n=t[0].mime+";charset=utf-8;base64,"+t[0].base64;o(3,l=await e.imageAPI.setColorPreserveAlpha(n,255,0,0)),o(4,a=t[1].mime+";charset=utf-8;base64,"+t[1].base64),o(0,c.componentToolbar.showImageButtons=!0,c),c.componentToolbar.refresh()};await e.ComfyUI.executeWorkflow(t,u,n,r,i)}}},function(t){v[t?"unshift":"push"]((()=>{c.element=t,o(0,c)}))},(t,e)=>{p(e,t)}]}customElements.define("fds-image-editor-sam-floating-toolbar",class extends q{constructor(t){super();const e=document.createElement("style");e.textContent=".toggle{vertical-align:middle}",this.shadowRoot.appendChild(e),L(this,{target:this.shadowRoot,props:$(this.attributes),customElement:!0},K,G,r,{tool_layer:0,showImageButtons:1,refresh:2},null),t&&(t.target&&u(t.target,this,t.anchor),t.props&&(this.$set(t.props),S()))}static get observedAttributes(){return["tool_layer","showImageButtons","refresh"]}get tool_layer(){return this.$$.ctx[0]}set tool_layer(t){this.$$set({tool_layer:t}),S()}get showImageButtons(){return this.$$.ctx[1]}set showImageButtons(t){this.$$set({showImageButtons:t}),S()}get refresh(){return this.$$.ctx[2]}});class rt extends q{constructor(t){super();const e=document.createElement("style");e.textContent=".selectionOuter{display:block;position:absolute;border:none;opacity:1;touch-action:none}.selectionInner{border:1px solid white;display:block;position:absolute;top:0;left:0;bottom:0;right:0;opacity:0.8;--angle:0deg;border:2px solid;border-image:conic-gradient(from var(--angle), red, yellow, lime, aqua, blue, magenta, red) 1;animation:10s rotate linear infinite}.selectionRect{border-image:conic-gradient(\n                from var(--angle),\n                rgb(216, 216, 216),\n                rgb(255, 255, 255),\n                rgb(203, 203, 203),\n                rgb(180, 180, 180),\n                rgb(101, 101, 101),\n                rgb(106, 106, 106),\n                rgb(129, 129, 129)\n            )\n            1}.loiPoint{border-radius:100%;border:1px solid white;width:20px;height:20px;position:absolute;margin-left:-10px;margin-top:-10px;background-color:green;cursor:not-allowed}.loiPointBackground{background-color:red}.loiPointsBack{position:absolute;left:0;top:0}.loiPoint:hover{transition:500ms ease-out;background-color:#000}.mask{opacity:0.5}.checkerBoard{background-repeat:repeat;background-size:20px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAACYSURBVHhe7dqxEcAgEMRAcEv03wHUZDtQDwTSJvr4ZsiY729cdM7huuOhWg1AtRqAajUA1WoAqtUAVKsBqFYDUK0GoFoNQLUagGo1ANVqAKrVAFSrAahWA1Ctufe++j9grcV1R0+AajUA1WoAqtUAVKsBqFYDUK0GoFoNQLUagGo1ANVqAKrVAFSrAahWA1CtBqBa8gHG+AAQDQreoC53nAAAAABJRU5ErkJggg==)}",this.shadowRoot.appendChild(e),L(this,{target:this.shadowRoot,props:$(this.attributes),customElement:!0},it,nt,r,{tool_layer:0,refresh:8,action:9},null),t&&(t.target&&u(t.target,this,t.anchor),t.props&&(this.$set(t.props),S()))}static get observedAttributes(){return["tool_layer","refresh","action"]}get tool_layer(){return this.$$.ctx[0]}set tool_layer(t){this.$$set({tool_layer:t}),S()}get refresh(){return this.$$.ctx[8]}get action(){return this.$$.ctx[9]}}customElements.define("fds-image-editor-sam",rt);export{rt as default};
//# sourceMappingURL=fds-image-editor-sam-es.js.map
