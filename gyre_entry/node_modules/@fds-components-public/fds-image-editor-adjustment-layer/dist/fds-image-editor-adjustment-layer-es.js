function e(){}function t(e){return e()}function n(){return Object.create(null)}function r(e){e.forEach(t)}function a(e){return"function"==typeof e}function o(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}let i,l;function s(e,t){return i||(i=document.createElement("a")),i.href=t,e===i.href}function u(e,t){e.appendChild(t)}function c(e,t,n){e.insertBefore(t,n||null)}function d(e){e.parentNode&&e.parentNode.removeChild(e)}function f(e){return document.createElement(e)}function m(e){return document.createTextNode(e)}function g(){return m(" ")}function p(){return m("")}function h(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}function y(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function _(e,t,n){t in e?e[t]="boolean"==typeof e[t]&&""===n||n:y(e,t,n)}function w(e,t,n,r){null==n?e.style.removeProperty(t):e.style.setProperty(t,n,r?"important":"")}function v(e,t,n){for(let n=0;n<e.options.length;n+=1){const r=e.options[n];if(r.__value===t)return void(r.selected=!0)}n&&void 0===t||(e.selectedIndex=-1)}function $(e){const t=e.querySelector(":checked");return t&&t.__value}function b(e){const t={};for(const n of e)t[n.name]=n.value;return t}function x(e){l=e}function k(e){(function(){if(!l)throw new Error("Function called outside component initialization");return l})().$$.on_mount.push(e)}const C=[],I=[];let E=[];const j=[],L=Promise.resolve();let N=!1;function S(){N||(N=!0,L.then(F))}function T(e){E.push(e)}const A=new Set;let M=0;function F(){if(0!==M)return;const e=l;do{try{for(;M<C.length;){const e=C[M];M++,x(e),U(e.$$)}}catch(e){throw C.length=0,M=0,e}for(x(null),C.length=0,M=0;I.length;)I.pop()();for(let e=0;e<E.length;e+=1){const t=E[e];A.has(t)||(A.add(t),t())}E.length=0}while(C.length);for(;j.length;)j.pop()();N=!1,A.clear(),x(e)}function U(e){if(null!==e.fragment){e.update(),r(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(T)}}const D=new Set;function O(e,t){const n=e.$$;null!==n.fragment&&(!function(e){const t=[],n=[];E.forEach((r=>-1===e.indexOf(r)?t.push(r):n.push(r))),n.forEach((e=>e())),E=t}(n.after_update),r(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function P(o,i,s,u,c,f,m,g=[-1]){const p=l;x(o);const h=o.$$={fragment:null,ctx:[],props:f,update:e,not_equal:c,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(i.context||(p?p.$$.context:[])),callbacks:n(),dirty:g,skip_bound:!1,root:i.target||p.$$.root};m&&m(h.root);let y=!1;if(h.ctx=s?s(o,i.props||{},((e,t,...n)=>{const r=n.length?n[0]:t;return h.ctx&&c(h.ctx[e],h.ctx[e]=r)&&(!h.skip_bound&&h.bound[e]&&h.bound[e](r),y&&function(e,t){-1===e.$$.dirty[0]&&(C.push(e),S(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}(o,e)),t})):[],h.update(),y=!0,r(h.before_update),h.fragment=!!u&&u(h.ctx),i.target){if(i.hydrate){const e=function(e){return Array.from(e.childNodes)}(i.target);h.fragment&&h.fragment.l(e),e.forEach(d)}else h.fragment&&h.fragment.c();i.intro&&((_=o.$$.fragment)&&_.i&&(D.delete(_),_.i(w))),function(e,n,o,i){const{fragment:l,after_update:s}=e.$$;l&&l.m(n,o),i||T((()=>{const n=e.$$.on_mount.map(t).filter(a);e.$$.on_destroy?e.$$.on_destroy.push(...n):r(n),e.$$.on_mount=[]})),s.forEach(T)}(o,i.target,i.anchor,i.customElement),F()}var _,w;x(p)}let B;function H(e){let t,n,a,o,i,l,s,w,$,b,x,k,C,I,E,j=e[0].workflowname+"",L=e[2]&&R(e);return{c(){t=f("fds-image-editor-button"),n=m("\n\n      Adjustment Layer:\n      "),a=m(j),o=g(),i=f("fds-image-editor-button"),i.textContent="Properties...",l=m("    \n\n        \n      "),s=f("select"),w=f("option"),w.textContent="All layers below",$=f("option"),$.textContent="1",b=f("option"),b.textContent="2",x=f("option"),x.textContent="3",k=g(),L&&L.c(),C=p(),_(t,"icon","fds-image-editor-adjustment-layer-icon"),_(t,"type","icon"),_(t,"class","icon"),_(i,"type","button"),w.__value="all",w.value=w.__value,$.__value="1",$.value=$.__value,b.__value="2",b.value=b.__value,x.__value="3",x.value=x.__value,y(s,"class","formInput"),y(s,"name","num_layers"),void 0===e[0].mergeNum&&T((()=>e[10].call(s)))},m(r,d){c(r,t,d),c(r,n,d),c(r,a,d),c(r,o,d),c(r,i,d),e[9](i),c(r,l,d),c(r,s,d),u(s,w),u(s,$),u(s,b),u(s,x),v(s,e[0].mergeNum,!0),c(r,k,d),L&&L.m(r,d),c(r,C,d),I||(E=[h(i,"click",e[5]),h(s,"change",e[10])],I=!0)},p(e,t){1&t&&j!==(j=e[0].workflowname+"")&&function(e,t){t=""+t,e.data!==t&&(e.data=t)}(a,j),1&t&&v(s,e[0].mergeNum),e[2]?L?L.p(e,t):(L=R(e),L.c(),L.m(C.parentNode,C)):L&&(L.d(1),L=null)},d(u){u&&d(t),u&&d(n),u&&d(a),u&&d(o),u&&d(i),e[9](null),u&&d(l),u&&d(s),u&&d(k),L&&L.d(u),u&&d(C),I=!1,r(E)}}}function J(t){let n,r,a,o,i;return{c(){n=f("fds-image-editor-button"),r=m("\n\n      Adjustment Layer:\n      \n      "),a=f("fds-image-editor-button"),a.textContent="Select Workflow...",_(n,"icon","fds-image-editor-adjustment-layer-icon"),_(n,"type","icon"),_(n,"class","icon"),_(a,"type","button")},m(e,l){c(e,n,l),c(e,r,l),c(e,a,l),t[8](a),o||(i=h(a,"click",t[4]),o=!0)},p:e,d(e){e&&d(n),e&&d(r),e&&d(a),t[8](null),o=!1,i()}}}function R(e){let t,n,a,o,i,l,s,_,w,$,b,x,k,C="never"===e[2].adjustment_layer_update&&q(e);return{c(){t=m("   "),n=f("select"),a=f("option"),a.textContent="No auto update",o=f("option"),o.textContent="250ms",i=f("option"),i.textContent="500ms",l=f("option"),l.textContent="1s",s=f("option"),s.textContent="2s",_=f("option"),_.textContent="5s",w=f("option"),w.textContent="10s",$=g(),C&&C.c(),b=p(),a.__value="never",a.value=a.__value,o.__value="250",o.value=o.__value,i.__value="500",i.value=i.__value,l.__value="1000",l.value=l.__value,s.__value="2000",s.value=s.__value,_.__value="5000",_.value=_.__value,w.__value="10000",w.value=w.__value,y(n,"class","formInput"),y(n,"name","adjustment_layer_update"),void 0===e[2].adjustment_layer_update&&T((()=>e[11].call(n)))},m(r,d){c(r,t,d),c(r,n,d),u(n,a),u(n,o),u(n,i),u(n,l),u(n,s),u(n,_),u(n,w),v(n,e[2].adjustment_layer_update,!0),c(r,$,d),C&&C.m(r,d),c(r,b,d),x||(k=[h(n,"change",e[6]),h(n,"change",e[11])],x=!0)},p(e,t){4&t&&v(n,e[2].adjustment_layer_update),"never"===e[2].adjustment_layer_update?C?C.p(e,t):(C=q(e),C.c(),C.m(b.parentNode,b)):C&&(C.d(1),C=null)},d(e){e&&d(t),e&&d(n),e&&d($),C&&C.d(e),e&&d(b),x=!1,r(k)}}}function q(t){let n,r,a,o;return{c(){n=m(" \n      \n      "),r=f("fds-image-editor-button"),r.textContent="Update Now",_(r,"type","button"),_(r,"state","active")},m(e,i){c(e,n,i),c(e,r,i),t[12](r),a||(o=h(r,"click",t[1]),a=!0)},p:e,d(e){e&&d(n),e&&d(r),t[12](null),a=!1,o()}}}function z(t){let n;function r(e,t){return e[0].workflowid?H:J}let a=r(t),o=a(t);return{c(){n=f("div"),o.c(),this.c=e},m(e,t){c(e,n,t),o.m(n,null)},p(e,[t]){a===(a=r(e))&&o?o.p(e,t):(o.d(1),o=a(e),o&&(o.c(),o.m(n,null)))},i:e,o:e,d(e){e&&d(n),o.d()}}}function G(e,t,n){let r,{layer:a={}}=t;async function o(e){await l()}function i(){globalThis.gyre.openDialogById(a.workflowid,a.formData,a.workflowname,(e=>{n(0,a.formData=e,a)}))}async function l(){let e=globalThis.gyre.layerManager.getLayersSameGroup(a.id);if(e&&1!==e.length)for(let t=e.length-1;t>=0;t--){let n=e[t];if("fds-image-editor-adjustment-layer"===n.type&&n.visible){let e=n.element.getElementsByTagName("fds-image-editor-adjustment-layer")[0];await e.execute()}}}k((async()=>{n(2,s=globalThis.gyre.paletteValues),s.adjustment_layer_update||n(2,s.adjustment_layer_update="never",s),a.mergeNum||n(0,a.mergeNum="all",a),d()}));let s,u,c={};function d(){if(!globalThis.gyre)return;let e=globalThis.gyre;if(!e.ComfyUI||!e.ComfyUI.workflowList)return;let t=e.ComfyUI.workflowList.filter((t=>{let n=JSON.parse(t.json).extra.gyre;return!(!n.tags||!n.tags.includes("LayerMenu"))&&((!n.tags||!n.tags.includes("Deactivated"))&&(n.category||(n.category="Other"),!!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","currentLayer")&&(!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","nextLayer")&&(!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","layerBelow")&&(!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","previousLayer")&&(!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","layerAbove")&&(!e.ComfyUI.checkFormElement(n.workflowid,"drop_layers")&&1===function(e){let t=0;for(let n in e.mappings)e.mappings.hasOwnProperty(n)&&e.mappings[n].forEach((e=>{"resultImage"===e.fromField&&t++}));return t}(n))))))))})).map((e=>{let t=JSON.parse(e.json).extra.gyre;return{name:e.name,category:t.category,workflowid:t.workflowid,no_preserve_transparency:t.no_preserve_transparency}}));c=function(e){const t={};return e.forEach((e=>{const n=e.category.toLowerCase()+"Menu",r=e.name.replace(/\s+/g,"").toLowerCase();t[n]||(t[n]={name:e.category,items:{}}),t[n].items[r]={workflowid:e.workflowid,name:e.name}})),t}(t)}return e.$$set=e=>{"layer"in e&&n(0,a=e.layer)},[a,l,s,u,function(){var e=window.document.createElement("fds-image-editor-menu");e.menu=c,e.element=u,e.callback=e=>{n(0,a.workflowid=e.workflowid,a),n(0,a.workflowname=e.name,a),n(0,a.no_preserve_transparency=e.no_preserve_transparency,a),n(0,a.formData={},a),n(0,a.name=e.name,a),n(0,a),globalThis.gyre.layerManager.selectLayers([a.id]),globalThis.gyre.paletteValues.adjustment_layer_update&&"never"!==globalThis.gyre.paletteValues.adjustment_layer_update&&(r=globalThis.gyre.layerManager.observeChangesSameGroup(a.id,o,parseInt(globalThis.gyre.paletteValues.adjustment_layer_update))),i()},document.body.append(e)},i,function(e){"never"!==e.target.value?r=globalThis.gyre.layerManager.observeChangesSameGroup(a.id,o,parseInt(e.target.value)):globalThis.gyre.layerManager.deleteObserver(r)},d,function(e){I[e?"unshift":"push"]((()=>{u=e,n(3,u)}))},function(e){I[e?"unshift":"push"]((()=>{u=e,n(3,u)}))},function(){a.mergeNum=$(this),n(0,a)},function(){s.adjustment_layer_update=$(this),n(2,s)},function(e){I[e?"unshift":"push"]((()=>{u=e,n(3,u)}))}]}"function"==typeof HTMLElement&&(B=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:e}=this.$$;this.$$.on_disconnect=e.map(t).filter(a);for(const e in this.$$.slotted)this.appendChild(this.$$.slotted[e])}attributeChangedCallback(e,t,n){this[e]=n}disconnectedCallback(){r(this.$$.on_disconnect)}$destroy(){O(this,1),this.$destroy=e}$on(t,n){if(!a(n))return e;const r=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return r.push(n),()=>{const e=r.indexOf(n);-1!==e&&r.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}});function V(e){let t,n,r,a,o,i,l,m=e[3]&&W();return{c(){t=f("div"),n=f("img"),i=g(),m&&m.c(),l=p(),s(n.src,r=e[0].url)||y(n,"src",r),y(n,"style",a="width:"+e[1]+"px;height="+e[2]+"px"),y(t,"style",o=e[1]+"px;height="+e[2]+"px; position: relative")},m(e,r){c(e,t,r),u(t,n),c(e,i,r),m&&m.m(e,r),c(e,l,r)},p(e,i){1&i&&!s(n.src,r=e[0].url)&&y(n,"src",r),6&i&&a!==(a="width:"+e[1]+"px;height="+e[2]+"px")&&y(n,"style",a),6&i&&o!==(o=e[1]+"px;height="+e[2]+"px; position: relative")&&y(t,"style",o),e[3]?m||(m=W(),m.c(),m.m(l.parentNode,l)):m&&(m.d(1),m=null)},d(e){e&&d(t),e&&d(i),m&&m.d(e),e&&d(l)}}}function W(e){let t;return{c(){t=f("div"),t.innerHTML="<fds-image-editor-progress-bar></fds-image-editor-progress-bar>",w(t,"position","absolute"),w(t,"left","0"),w(t,"top","0")},m(e,n){c(e,t,n)},d(e){e&&d(t)}}}function K(t){let n,r=t[0].url&&V(t);return{c(){r&&r.c(),n=p(),this.c=e},m(e,t){r&&r.m(e,t),c(e,n,t)},p(e,[t]){e[0].url?r?r.p(e,t):(r=V(e),r.c(),r.m(n.parentNode,n)):r&&(r.d(1),r=null)},i:e,o:e,d(e){r&&r.d(e),e&&d(n)}}}async function Q(e){}function X(){class e extends(globalThis.gyre.getLayerBaseClass()){background_type;workflow;workflowData;formData;workflowid;workflowname}let t=new e;return t.type="fds-image-editor-adjustment-layer",t.name="Adjustment",t.letter="A",t.background_type="transparent",t.workflow="",t.workflowData={},t}async function Y(){return null}function Z(e,t,n){let r,a,{width:o=500}=t,{height:i=500}=t,{layer:l={}}=t;function s(){n(0,l)}function u(){return JSON.parse(JSON.stringify(l))}return k((()=>()=>{n(0,l.data=u(),l)})),e.$$set=e=>{"width"in e&&n(1,o=e.width),"height"in e&&n(2,i=e.height),"layer"in e&&n(0,l=e.layer)},[l,o,i,a,s,Q,u,async function(e){let t=e;for(let e in t)n(0,l[e]=t[e],l);s()},X,async function(){let e=JSON.parse(JSON.stringify(l));return e.url=null,e},function(e,t,n){return l.workflowid||(e.name="Select Workflow..."),"<div "+t+' style="'+n+' font-size:33px;font-weight:bold;display:flex;align-content:space-between;justify-content:space-around;align-items: center;"><fds-image-editor-button icon="fds-image-editor-adjustment-layer-icon" type="icon"></fds-image-editor-button></div> '+e.name},Y,async function(){if(!l.formData)return;let e=globalThis.gyre,t=e.layerManager.getLayersSameGroup(l.id);if(!t||1===t.length)return;let o=[];for(let e=t.length-1;e>=0;e--){let n=t[e];if(n.id===l.id)break;n.url&&(n.visible||"mask"===n.type||1==l.mergeNum)&&o.unshift(n)}if("all"!==l.mergeNum&&o.length>l.mergeNum&&(o=o.slice(0,l.mergeNum)),!o.length)return;n(3,a=!0),await(S(),L),"mask"===o[0].type&&(o=o.slice(0,1),n(0,l.mergeNum=1,l)),r="mask"===o[0].type?await async function(e){return e.url}(o[0]):await async function(e,t){const n=window.document.createElement("canvas");n.width=t.width,n.height=t.height;const r=n.getContext("2d");r.clearRect(0,0,n.width,n.height);for(let n=e.length-1;n>=0;n--){const a=e[n];if(r.save(),a.canvas){if(a.rotation){r.globalAlpha=a.opacity/100;const e=a.x+a.width/2,t=a.y+a.height/2;r.translate(e,t),r.rotate(a.rotation),r.translate(-e,-t)}r.drawImage(a.canvas.canvas.canvasList[0],a.x,a.y,a.width,a.height)}else r.drawImage(await globalThis.gyre.imageAPI.loadImage(await a.renderInDocumentSize()),0,0,t.width,t.height);r.restore()}return n.toDataURL()}(o,e.canvas);let i=async(e,t,n,a,o)=>{if("getLayerImage"===e&&"currentLayer"===t)return await r},s=async e=>{},u=e.ComfyUI.convertFormData(l.formData);u.currentLayer="empty",await new Promise(((t,c)=>{e.ComfyUI.executeWorkflowById(l.workflowid,(async i=>{let s=i[0].mime+";charset=utf-8;base64,"+i[0].base64;"mask"===o[0].type?(n(0,l.url=s,l),n(0,l.ref=o[0].id,l),n(0,l.refType="moveTool",l)):l.no_preserve_transparency?n(0,l.url=s,l):n(0,l.url=await e.imageAPI.applyAlphaChannel(s,r),l),n(3,a=!1),l.element.getElementsByTagName("fds-image-editor-adjustment-layer")[0].refresh(),t()}),i,u,s)}))}]}customElements.define("fds-image-editor-adjustment-layer-toolbar",class extends B{constructor(e){super();const t=document.createElement("style");t.textContent=".icon{vertical-align:-10px}.formInput{display:inline-block;outline:0;border:0;border-bottom:2px solid rgba(255, 255, 255, 0.2);margin-bottom:10px;padding:5px;font-size:14px;font-weight:normal;border-radius:3px;color:rgba(255, 255, 255, 0.9);font-family:system-ui, 'Segoe UI', Roboto;background:black}",this.shadowRoot.appendChild(t),P(this,{target:this.shadowRoot,props:b(this.attributes),customElement:!0},G,z,o,{layer:0,executeAll:1,refresh:7},null),e&&(e.target&&c(e.target,this,e.anchor),e.props&&(this.$set(e.props),F()))}static get observedAttributes(){return["layer","executeAll","refresh"]}get layer(){return this.$$.ctx[0]}set layer(e){this.$$set({layer:e}),F()}get executeAll(){return this.$$.ctx[1]}get refresh(){return this.$$.ctx[7]}});class ee extends B{constructor(e){super(),P(this,{target:this.shadowRoot,props:b(this.attributes),customElement:!0},Z,K,o,{width:1,height:2,layer:0,refresh:4,prepareForAI:5,getScene:6,setScene:7,layerInstance:8,prepareForSave:9,getLayerMenuHTML:10,quickMask:11,execute:12},null),e&&(e.target&&c(e.target,this,e.anchor),e.props&&(this.$set(e.props),F()))}static get observedAttributes(){return["width","height","layer","refresh","prepareForAI","getScene","setScene","layerInstance","prepareForSave","getLayerMenuHTML","quickMask","execute"]}get width(){return this.$$.ctx[1]}set width(e){this.$$set({width:e}),F()}get height(){return this.$$.ctx[2]}set height(e){this.$$set({height:e}),F()}get layer(){return this.$$.ctx[0]}set layer(e){this.$$set({layer:e}),F()}get refresh(){return this.$$.ctx[4]}get prepareForAI(){return Q}get getScene(){return this.$$.ctx[6]}get setScene(){return this.$$.ctx[7]}get layerInstance(){return X}get prepareForSave(){return this.$$.ctx[9]}get getLayerMenuHTML(){return this.$$.ctx[10]}get quickMask(){return Y}get execute(){return this.$$.ctx[12]}}customElements.define("fds-image-editor-adjustment-layer",ee);export{ee as default};
//# sourceMappingURL=fds-image-editor-adjustment-layer-es.js.map
