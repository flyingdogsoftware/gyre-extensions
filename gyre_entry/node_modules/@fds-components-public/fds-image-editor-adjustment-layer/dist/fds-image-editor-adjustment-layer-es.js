function e(){}function t(e){return e()}function n(){return Object.create(null)}function r(e){e.forEach(t)}function o(e){return"function"==typeof e}function a(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}let i,l;function s(e,t){return i||(i=document.createElement("a")),i.href=t,e===i.href}function u(e,t){e.appendChild(t)}function c(e,t,n){e.insertBefore(t,n||null)}function d(e){e.parentNode&&e.parentNode.removeChild(e)}function f(e){return document.createElement(e)}function m(e){return document.createTextNode(e)}function p(){return m(" ")}function g(){return m("")}function h(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}function y(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function _(e,t,n){t in e?e[t]="boolean"==typeof e[t]&&""===n||n:y(e,t,n)}function w(e,t,n,r){null==n?e.style.removeProperty(t):e.style.setProperty(t,n,r?"important":"")}function v(e,t,n){for(let n=0;n<e.options.length;n+=1){const r=e.options[n];if(r.__value===t)return void(r.selected=!0)}n&&void 0===t||(e.selectedIndex=-1)}function $(e){const t=e.querySelector(":checked");return t&&t.__value}function b(e){const t={};for(const n of e)t[n.name]=n.value;return t}function x(e){l=e}function k(e){(function(){if(!l)throw new Error("Function called outside component initialization");return l})().$$.on_mount.push(e)}const C=[],L=[];let E=[];const j=[],I=Promise.resolve();let N=!1;function T(){N||(N=!0,I.then(F))}function M(e){E.push(e)}const A=new Set;let S=0;function F(){if(0!==S)return;const e=l;do{try{for(;S<C.length;){const e=C[S];S++,x(e),U(e.$$)}}catch(e){throw C.length=0,S=0,e}for(x(null),C.length=0,S=0;L.length;)L.pop()();for(let e=0;e<E.length;e+=1){const t=E[e];A.has(t)||(A.add(t),t())}E.length=0}while(C.length);for(;j.length;)j.pop()();N=!1,A.clear(),x(e)}function U(e){if(null!==e.fragment){e.update(),r(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(M)}}const O=new Set;function D(e,t){const n=e.$$;null!==n.fragment&&(!function(e){const t=[],n=[];E.forEach((r=>-1===e.indexOf(r)?t.push(r):n.push(r))),n.forEach((e=>e())),E=t}(n.after_update),r(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function P(a,i,s,u,c,f,m,p=[-1]){const g=l;x(a);const h=a.$$={fragment:null,ctx:[],props:f,update:e,not_equal:c,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(i.context||(g?g.$$.context:[])),callbacks:n(),dirty:p,skip_bound:!1,root:i.target||g.$$.root};m&&m(h.root);let y=!1;if(h.ctx=s?s(a,i.props||{},((e,t,...n)=>{const r=n.length?n[0]:t;return h.ctx&&c(h.ctx[e],h.ctx[e]=r)&&(!h.skip_bound&&h.bound[e]&&h.bound[e](r),y&&function(e,t){-1===e.$$.dirty[0]&&(C.push(e),T(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}(a,e)),t})):[],h.update(),y=!0,r(h.before_update),h.fragment=!!u&&u(h.ctx),i.target){if(i.hydrate){const e=function(e){return Array.from(e.childNodes)}(i.target);h.fragment&&h.fragment.l(e),e.forEach(d)}else h.fragment&&h.fragment.c();i.intro&&((_=a.$$.fragment)&&_.i&&(O.delete(_),_.i(w))),function(e,n,a,i){const{fragment:l,after_update:s}=e.$$;l&&l.m(n,a),i||M((()=>{const n=e.$$.on_mount.map(t).filter(o);e.$$.on_destroy?e.$$.on_destroy.push(...n):r(n),e.$$.on_mount=[]})),s.forEach(M)}(a,i.target,i.anchor,i.customElement),F()}var _,w;x(g)}let B;function H(e){let t,n,o,a,i,l,s,w,$,b,x,k,C,L,E,j=e[0].workflowname+"",I=e[2]&&q(e);return{c(){t=f("fds-image-editor-button"),n=m("\n\n      Adjustment Layer:\n      "),o=m(j),a=p(),i=f("fds-image-editor-button"),i.textContent="Properties...",l=m("    \n\n        \n      "),s=f("select"),w=f("option"),w.textContent="All layers below",$=f("option"),$.textContent="1",b=f("option"),b.textContent="2",x=f("option"),x.textContent="3",k=p(),I&&I.c(),C=g(),_(t,"icon","fds-image-editor-adjustment-layer-icon"),_(t,"type","icon"),_(t,"class","icon"),_(i,"type","button"),w.__value="all",w.value=w.__value,$.__value="1",$.value=$.__value,b.__value="2",b.value=b.__value,x.__value="3",x.value=x.__value,y(s,"class","formInput"),y(s,"name","num_layers"),void 0===e[0].mergeNum&&M((()=>e[10].call(s)))},m(r,d){c(r,t,d),c(r,n,d),c(r,o,d),c(r,a,d),c(r,i,d),e[9](i),c(r,l,d),c(r,s,d),u(s,w),u(s,$),u(s,b),u(s,x),v(s,e[0].mergeNum,!0),c(r,k,d),I&&I.m(r,d),c(r,C,d),L||(E=[h(i,"click",e[5]),h(s,"change",e[10])],L=!0)},p(e,t){1&t&&j!==(j=e[0].workflowname+"")&&function(e,t){t=""+t,e.data!==t&&(e.data=t)}(o,j),1&t&&v(s,e[0].mergeNum),e[2]?I?I.p(e,t):(I=q(e),I.c(),I.m(C.parentNode,C)):I&&(I.d(1),I=null)},d(u){u&&d(t),u&&d(n),u&&d(o),u&&d(a),u&&d(i),e[9](null),u&&d(l),u&&d(s),u&&d(k),I&&I.d(u),u&&d(C),L=!1,r(E)}}}function R(t){let n,r,o,a,i;return{c(){n=f("fds-image-editor-button"),r=m("\n\n      Adjustment Layer:\n      \n      "),o=f("fds-image-editor-button"),o.textContent="Select Workflow...",_(n,"icon","fds-image-editor-adjustment-layer-icon"),_(n,"type","icon"),_(n,"class","icon"),_(o,"type","button")},m(e,l){c(e,n,l),c(e,r,l),c(e,o,l),t[8](o),a||(i=h(o,"click",t[4]),a=!0)},p:e,d(e){e&&d(n),e&&d(r),e&&d(o),t[8](null),a=!1,i()}}}function q(e){let t,n,o,a,i,l,s,_,w,$,b,x,k,C="never"===e[2].adjustment_layer_update&&G(e);return{c(){t=m("   "),n=f("select"),o=f("option"),o.textContent="No auto update",a=f("option"),a.textContent="250ms",i=f("option"),i.textContent="500ms",l=f("option"),l.textContent="1s",s=f("option"),s.textContent="2s",_=f("option"),_.textContent="5s",w=f("option"),w.textContent="10s",$=p(),C&&C.c(),b=g(),o.__value="never",o.value=o.__value,a.__value="250",a.value=a.__value,i.__value="500",i.value=i.__value,l.__value="1000",l.value=l.__value,s.__value="2000",s.value=s.__value,_.__value="5000",_.value=_.__value,w.__value="10000",w.value=w.__value,y(n,"class","formInput"),y(n,"name","adjustment_layer_update"),void 0===e[2].adjustment_layer_update&&M((()=>e[11].call(n)))},m(r,d){c(r,t,d),c(r,n,d),u(n,o),u(n,a),u(n,i),u(n,l),u(n,s),u(n,_),u(n,w),v(n,e[2].adjustment_layer_update,!0),c(r,$,d),C&&C.m(r,d),c(r,b,d),x||(k=[h(n,"change",e[6]),h(n,"change",e[11])],x=!0)},p(e,t){4&t&&v(n,e[2].adjustment_layer_update),"never"===e[2].adjustment_layer_update?C?C.p(e,t):(C=G(e),C.c(),C.m(b.parentNode,b)):C&&(C.d(1),C=null)},d(e){e&&d(t),e&&d(n),e&&d($),C&&C.d(e),e&&d(b),x=!1,r(k)}}}function G(t){let n,r,o,a;return{c(){n=m(" \n      \n      "),r=f("fds-image-editor-button"),r.textContent="Update Now",_(r,"type","button"),_(r,"state","active")},m(e,i){c(e,n,i),c(e,r,i),t[12](r),o||(a=h(r,"click",t[1]),o=!0)},p:e,d(e){e&&d(n),e&&d(r),t[12](null),o=!1,a()}}}function J(t){let n;function r(e,t){return e[0].workflowid?H:R}let o=r(t),a=o(t);return{c(){n=f("div"),a.c(),this.c=e},m(e,t){c(e,n,t),a.m(n,null)},p(e,[t]){o===(o=r(e))&&a?a.p(e,t):(a.d(1),a=o(e),a&&(a.c(),a.m(n,null)))},i:e,o:e,d(e){e&&d(n),a.d()}}}function V(e,t,n){let r,{layer:o={}}=t;async function a(e){await l()}function i(){globalThis.gyre.openDialogById(o.workflowid,o.formData,o.workflowname,(e=>{n(0,o.formData=e,o)}))}async function l(){let e=globalThis.gyre.layerManager.getLayersSameGroup(o.id);if(e&&1!==e.length)for(let t=e.length-1;t>=0;t--){let n=e[t];if("fds-image-editor-adjustment-layer"===n.type&&n.visible){let e=n.element.getElementsByTagName("fds-image-editor-adjustment-layer")[0];await e.execute()}}}k((async()=>{n(2,s=globalThis.gyre.paletteValues),s.adjustment_layer_update||n(2,s.adjustment_layer_update="never",s),o.mergeNum||n(0,o.mergeNum="all",o),d()}));let s,u,c={};function d(){if(!globalThis.gyre)return;let e=globalThis.gyre;if(!e.ComfyUI||!e.ComfyUI.workflowList)return;let t=e.ComfyUI.workflowList.filter((t=>{let n=JSON.parse(t.json).extra.gyre;return!(!n.tags||!n.tags.includes("LayerMenu"))&&((!n.tags||!n.tags.includes("Deactivated"))&&(n.category||(n.category="Other"),!!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","currentLayer")&&(!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","nextLayer")&&(!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","layerBelow")&&(!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","previousLayer")&&(!e.ComfyUI.checkFormElement(n.workflowid,"layer_image","layerAbove")&&(!e.ComfyUI.checkFormElement(n.workflowid,"drop_layers")&&1===function(e){let t=0;for(let n in e.mappings)e.mappings.hasOwnProperty(n)&&e.mappings[n].forEach((e=>{"resultImage"===e.fromField&&t++}));return t}(n))))))))})).map((e=>{let t=JSON.parse(e.json).extra.gyre;return{name:e.name,category:t.category,workflowid:t.workflowid,no_preserve_transparency:t.no_preserve_transparency}}));c=function(e){const t={};return e.forEach((e=>{const n=e.category.toLowerCase()+"Menu",r=e.name.replace(/\s+/g,"").toLowerCase();t[n]||(t[n]={name:e.category,items:{}}),t[n].items[r]={workflowid:e.workflowid,name:e.name}})),t}(t)}return e.$$set=e=>{"layer"in e&&n(0,o=e.layer)},[o,l,s,u,function(){var e=window.document.createElement("fds-image-editor-menu");e.menu=c,e.element=u,e.callback=(e,t,l)=>{n(0,o.workflowid=l.workflowid,o),n(0,o.workflowname=l.name,o),n(0,o.no_preserve_transparency=l.no_preserve_transparency,o),n(0,o.formData={},o),n(0,o.name=l.name,o),n(0,o),globalThis.gyre.layerManager.selectLayers([o.id]),globalThis.gyre.paletteValues.adjustment_layer_update&&"never"!==globalThis.gyre.paletteValues.adjustment_layer_update&&(r=globalThis.gyre.layerManager.observeChangesSameGroup(o.id,a,parseInt(globalThis.gyre.paletteValues.adjustment_layer_update))),i()},document.body.append(e)},i,function(e){"never"!==e.target.value?r=globalThis.gyre.layerManager.observeChangesSameGroup(o.id,a,parseInt(e.target.value)):globalThis.gyre.layerManager.deleteObserver(r)},d,function(e){L[e?"unshift":"push"]((()=>{u=e,n(3,u)}))},function(e){L[e?"unshift":"push"]((()=>{u=e,n(3,u)}))},function(){o.mergeNum=$(this),n(0,o)},function(){s.adjustment_layer_update=$(this),n(2,s)},function(e){L[e?"unshift":"push"]((()=>{u=e,n(3,u)}))}]}"function"==typeof HTMLElement&&(B=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:e}=this.$$;this.$$.on_disconnect=e.map(t).filter(o);for(const e in this.$$.slotted)this.appendChild(this.$$.slotted[e])}attributeChangedCallback(e,t,n){this[e]=n}disconnectedCallback(){r(this.$$.on_disconnect)}$destroy(){D(this,1),this.$destroy=e}$on(t,n){if(!o(n))return e;const r=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return r.push(n),()=>{const e=r.indexOf(n);-1!==e&&r.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}});function z(e){let t,n,r,o,a,i,l,m=e[3]&&W();return{c(){t=f("div"),n=f("img"),i=p(),m&&m.c(),l=g(),s(n.src,r=e[0].url)||y(n,"src",r),y(n,"style",o="width:"+e[1]+"px;height="+e[2]+"px"),y(t,"style",a=e[1]+"px;height="+e[2]+"px; position: relative")},m(e,r){c(e,t,r),u(t,n),c(e,i,r),m&&m.m(e,r),c(e,l,r)},p(e,i){1&i&&!s(n.src,r=e[0].url)&&y(n,"src",r),6&i&&o!==(o="width:"+e[1]+"px;height="+e[2]+"px")&&y(n,"style",o),6&i&&a!==(a=e[1]+"px;height="+e[2]+"px; position: relative")&&y(t,"style",a),e[3]?m||(m=W(),m.c(),m.m(l.parentNode,l)):m&&(m.d(1),m=null)},d(e){e&&d(t),e&&d(i),m&&m.d(e),e&&d(l)}}}function W(e){let t;return{c(){t=f("div"),t.innerHTML="<fds-image-editor-progress-bar></fds-image-editor-progress-bar>",w(t,"position","absolute"),w(t,"left","0"),w(t,"top","0")},m(e,n){c(e,t,n)},d(e){e&&d(t)}}}function K(t){let n,r=t[0].url&&z(t);return{c(){r&&r.c(),n=g(),this.c=e},m(e,t){r&&r.m(e,t),c(e,n,t)},p(e,[t]){e[0].url?r?r.p(e,t):(r=z(e),r.c(),r.m(n.parentNode,n)):r&&(r.d(1),r=null)},i:e,o:e,d(e){r&&r.d(e),e&&d(n)}}}async function Q(e){}function X(e){e.type="fds-image-editor-adjustment-layer",e.name="Adjustment",e.letter="A",e.background_type="transparent",e.workflow="",e.workflowData={}}async function Y(){return null}function Z(e,t,n){let r,o,{width:a=500}=t,{height:i=500}=t,{layer:l={}}=t;return k((()=>()=>{})),e.$$set=e=>{"width"in e&&n(1,a=e.width),"height"in e&&n(2,i=e.height),"layer"in e&&n(0,l=e.layer)},[l,a,i,o,function(){n(0,l)},Q,X,async function(){let e=JSON.parse(JSON.stringify(l));return e.url=null,e},function(e,t,n){return l.workflowid||(e.name="Select Workflow..."),"<div "+t+' style="'+n+' font-size:33px;font-weight:bold;display:flex;align-content:space-between;justify-content:space-around;align-items: center;"><fds-image-editor-button icon="fds-image-editor-adjustment-layer-icon" type="icon"></fds-image-editor-button></div> '+e.name},Y,async function(){if(!l.formData)return;let e=globalThis.gyre,t=e.layerManager.getLayersSameGroup(l.id);if(!t||1===t.length)return;let a=[];for(let e=t.length-1;e>=0;e--){let n=t[e];if(n.id===l.id)break;n.url&&n.visible&&a.unshift(n)}"all"!==l.mergeNum&&a.length>l.mergeNum&&(a=a.slice(0,l.mergeNum)),n(3,o=!0),await(T(),I),r=await async function(e,t){const n=window.document.createElement("canvas");n.width=t.width,n.height=t.height;const r=n.getContext("2d");function o(e){return new Promise(((t,n)=>{const r=new Image;r.onload=()=>t(r),r.onerror=n,r.src=e}))}r.clearRect(0,0,n.width,n.height);for(let t=e.length-1;t>=0;t--){const n=e[t],a=await o(n.url);n.canvas?r.drawImage(n.canvas.canvas.canvasList[0],n.x,n.y,n.width,n.height):r.drawImage(a,n.x,n.y,n.width,n.height)}return n.toDataURL()}(a,e.canvas);let i=async(e,t,n,o,a)=>{if("getLayerImage"===e&&"currentLayer"===t)return await r},s=async e=>{},u=e.ComfyUI.convertFormData(l.formData);u.currentLayer="empty",await new Promise(((t,a)=>{e.ComfyUI.executeWorkflowById(l.workflowid,(async a=>{let i=a[0].mime+";charset=utf-8;base64,"+a[0].base64;l.no_preserve_transparency?n(0,l.url=i,l):n(0,l.url=await e.imageAPI.applyAlphaChannel(i,r),l),n(3,o=!1),l.element.getElementsByTagName("fds-image-editor-adjustment-layer")[0].refresh(),t()}),i,u,s)}))}]}customElements.define("fds-image-editor-adjustment-layer-toolbar",class extends B{constructor(e){super();const t=document.createElement("style");t.textContent=".icon{vertical-align:-10px}.formInput{display:inline-block;outline:0;border:0;border-bottom:2px solid rgba(255, 255, 255, 0.2);margin-bottom:10px;padding:5px;font-size:14px;font-weight:normal;border-radius:3px;color:rgba(255, 255, 255, 0.9);font-family:system-ui, 'Segoe UI', Roboto;background:black}",this.shadowRoot.appendChild(t),P(this,{target:this.shadowRoot,props:b(this.attributes),customElement:!0},V,J,a,{layer:0,executeAll:1,refresh:7},null),e&&(e.target&&c(e.target,this,e.anchor),e.props&&(this.$set(e.props),F()))}static get observedAttributes(){return["layer","executeAll","refresh"]}get layer(){return this.$$.ctx[0]}set layer(e){this.$$set({layer:e}),F()}get executeAll(){return this.$$.ctx[1]}get refresh(){return this.$$.ctx[7]}});class ee extends B{constructor(e){super(),P(this,{target:this.shadowRoot,props:b(this.attributes),customElement:!0},Z,K,a,{width:1,height:2,layer:0,refresh:4,prepareForAI:5,addLayer:6,prepareForSave:7,getLayerMenuHTML:8,quickMask:9,execute:10},null),e&&(e.target&&c(e.target,this,e.anchor),e.props&&(this.$set(e.props),F()))}static get observedAttributes(){return["width","height","layer","refresh","prepareForAI","addLayer","prepareForSave","getLayerMenuHTML","quickMask","execute"]}get width(){return this.$$.ctx[1]}set width(e){this.$$set({width:e}),F()}get height(){return this.$$.ctx[2]}set height(e){this.$$set({height:e}),F()}get layer(){return this.$$.ctx[0]}set layer(e){this.$$set({layer:e}),F()}get refresh(){return this.$$.ctx[4]}get prepareForAI(){return Q}get addLayer(){return X}get prepareForSave(){return this.$$.ctx[7]}get getLayerMenuHTML(){return this.$$.ctx[8]}get quickMask(){return Y}get execute(){return this.$$.ctx[10]}}customElements.define("fds-image-editor-adjustment-layer",ee);export{ee as default};
//# sourceMappingURL=fds-image-editor-adjustment-layer-es.js.map
